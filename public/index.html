<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literature Review System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #2a5298;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: #2a5298;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #1e3c72;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-card {
            background: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-card h3 {
            color: #2a5298;
            margin-bottom: 10px;
        }

        .submissions-list,
        .reviews-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .submission-card,
        .review-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .submission-card h4,
        .review-card h4 {
            color: #2a5298;
            margin-bottom: 10px;
        }

        .submission-info p,
        .review-info p {
            margin-bottom: 8px;
            color: #666;
        }

        .awards-section {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .awards-section h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .award-item {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
        }

        .connected {
            background: #4caf50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Disconnected</div>
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="header">
            <h1>üèÜ Literature Review System</h1>
            <p>Confidential Literary Awards Platform with Fully Homomorphic Encryption</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('submit')">Submit Work</button>
                <button class="tab" onclick="switchTab('review')">Expert Review</button>
                <button class="tab" onclick="switchTab('status')">Status</button>
                <button class="tab" onclick="switchTab('awards')">Awards</button>
            </div>

            <!-- Submit Work -->
            <div id="submit" class="tab-content active">
                <div class="status-card">
                    <h3>üìù Work Submission</h3>
                    <p id="submissionStatus">Checking submission period status...</p>
                </div>

                <form id="submitForm">
                    <div class="form-group">
                        <label for="workTitle">Work Title</label>
                        <input type="text" id="workTitle" placeholder="Enter work title" required>
                    </div>

                    <div class="form-group">
                        <label for="authorName">Author Name</label>
                        <input type="text" id="authorName" placeholder="Enter author name" required>
                    </div>

                    <div class="form-group">
                        <label for="workGenre">Work Category</label>
                        <select id="workGenre" required>
                            <option value="">Select work category</option>
                            <option value="Fiction">Fiction</option>
                            <option value="Poetry">Poetry</option>
                            <option value="Drama">Drama</option>
                            <option value="Non-Fiction">Non-Fiction</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="workContent">Work Content (IPFS Hash)</label>
                        <textarea id="workContent" placeholder="Enter IPFS hash of your work for secure private storage" required></textarea>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">Submit Work</button>
                </form>

                <div class="submissions-list" id="submissionsList">
                    <!-- Submissions list will be dynamically loaded -->
                </div>
            </div>

            <!-- Expert Review -->
            <div id="review" class="tab-content">
                <div class="status-card">
                    <h3>üë®‚Äçüè´ Expert Review</h3>
                    <p id="reviewStatus">Checking review period status...</p>
                </div>

                <div id="reviewerRegistration">
                    <h3>Reviewer Registration</h3>
                    <form id="reviewerForm">
                        <div class="form-group">
                            <label for="reviewerName">Expert Name</label>
                            <input type="text" id="reviewerName" placeholder="Enter your full name" required>
                        </div>

                        <div class="form-group">
                            <label for="expertise">Area of Expertise</label>
                            <input type="text" id="expertise" placeholder="e.g., Modern Literature, Classical Poetry, Drama Theory" required>
                        </div>

                        <button type="submit" class="btn">Apply to be a Reviewer</button>
                    </form>
                </div>

                <div id="reviewSection" style="display:none;">
                    <h3>Work Review</h3>
                    <div id="worksToReview">
                        <!-- List of works to review -->
                    </div>

                    <form id="reviewForm" style="display:none;">
                        <input type="hidden" id="reviewWorkId">

                        <div class="form-group">
                            <label for="qualityScore">Quality Score (1-100)</label>
                            <input type="number" id="qualityScore" min="1" max="100" required>
                        </div>

                        <div class="form-group">
                            <label for="originalityScore">Originality Score (1-100)</label>
                            <input type="number" id="originalityScore" min="1" max="100" required>
                        </div>

                        <div class="form-group">
                            <label for="impactScore">Impact Score (1-100)</label>
                            <input type="number" id="impactScore" min="1" max="100" required>
                        </div>

                        <div class="form-group">
                            <label for="comments">Review Comments (Encrypted Storage)</label>
                            <textarea id="comments" placeholder="Enter your professional review comments - all content will be encrypted" required></textarea>
                        </div>

                        <button type="submit" class="btn">Submit Review</button>
                        <button type="button" class="btn" onclick="cancelReview()" style="background:#666; margin-left:10px;">Cancel</button>
                    </form>
                </div>
            </div>

            <!-- Status -->
            <div id="status" class="tab-content">
                <div class="status-card">
                    <h3>üìä Current Selection Status</h3>
                    <div id="currentStatus">
                        <p>Submission Period: <span id="currentSubmissionPeriod">-</span></p>
                        <p>Review Period: <span id="currentReviewPeriod">-</span></p>
                        <p>Submission Status: <span id="submissionActive">-</span></p>
                        <p>Review Status: <span id="reviewActive">-</span></p>
                    </div>
                </div>

                <div class="status-card">
                    <h3>üìà Statistics</h3>
                    <div id="statistics">
                        <p>Total Submissions: <span id="totalSubmissions">0</span></p>
                        <p>Registered Reviewers: <span id="totalReviewers">-</span></p>
                        <p>Completed Reviews: <span id="completedReviews">-</span></p>
                    </div>
                </div>

                <div class="reviews-list" id="reviewsList">
                    <!-- Review progress list -->
                </div>
            </div>

            <!-- Awards -->
            <div id="awards" class="tab-content">
                <div class="awards-section">
                    <h3>üèÜ Award Results</h3>
                    <div id="awardsList">
                        <p style="text-align:center; color:#666;">No award results announced yet</p>
                    </div>
                </div>

                <div class="status-card" style="margin-top:30px;">
                    <h3>üéØ Historical Awards</h3>
                    <div id="historicalAwards">
                        <!-- Historical awards records -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const contractAddress = "0xE30e4b2A47C0605AaBaAde36f15d804fec4F9CF0";
        const contractABI = [
            "function isSubmissionPeriodActive() view returns (bool)",
            "function isReviewPeriodActive() view returns (bool)",
            "function currentSubmissionPeriod() view returns (uint32)",
            "function currentReviewPeriod() view returns (uint32)",
            "function submitWork(string title, string author, string genre, string ipfsHash)",
            "function registerReviewer(string name, string expertise)",
            "function submitReview(uint32 workId, uint32 qualityScore, uint32 originalityScore, uint32 impactScore, string comments)",
            "function getSubmissionInfo(uint32 period, uint32 workId) view returns (string title, string author, string genre, bool submitted, bool reviewed, uint256 submissionTime, address submitter)",
            "function getReviewerProfile(address reviewer) view returns (string name, string expertise, bool isActive, uint32 reviewCount)",
            "function getPeriodStats(uint32 period) view returns (uint32 totalSubmissions, bool submissionActive, bool reviewActive)",
            "function getAwards(uint32 period) view returns (string[] categories, address[] winners, bool[] announced)",
            "function workCountPerPeriod(uint32) view returns (uint32)",
            "function authorizedReviewers(address) view returns (bool)",
            "event WorkSubmitted(uint32 indexed period, uint32 indexed workId, address indexed submitter)",
            "event ReviewSubmitted(uint32 indexed period, uint32 indexed workId, address indexed reviewer)",
            "event AwardAnnounced(uint32 indexed period, string category, address indexed winner)",
            "event ReviewerRegistered(address indexed reviewer, string name)"
        ];

        let provider;
        let signer;
        let contract;
        let userAccount;

        // Initialize Web3 connection
        async function initWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                    userAccount = await signer.getAddress();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);

                    updateConnectionStatus(true);
                    loadContractData();
                } catch (error) {
                    console.error("Failed to connect wallet:", error);
                    updateConnectionStatus(false);
                }
            } else {
                showNotification("Please install MetaMask wallet", "error");
                updateConnectionStatus(false);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = `Connected: ${userAccount?.slice(0,6)}...${userAccount?.slice(-4)}`;
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'connection-status disconnected';
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active state from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Activate corresponding tab button
            event.target.classList.add('active');

            // Load data based on tab
            if (tabName === 'status') {
                loadStatusData();
            } else if (tabName === 'awards') {
                loadAwardsData();
            }
        }

        // Load contract data
        async function loadContractData() {
            try {
                await checkSubmissionPeriod();
                await checkReviewPeriod();
                await loadSubmissions();
                await checkReviewerStatus();
            } catch (error) {
                console.error("Failed to load data:", error);
            }
        }

        // Check submission period status
        async function checkSubmissionPeriod() {
            try {
                const isActive = await contract.isSubmissionPeriodActive();
                const statusText = isActive ? "‚úÖ Submission period open" : "‚ùå Submission period closed";
                document.getElementById('submissionStatus').textContent = statusText;

                document.getElementById('submitBtn').disabled = !isActive;
            } catch (error) {
                console.error("Failed to check submission period:", error);
                document.getElementById('submissionStatus').textContent = "Failed to check status";
            }
        }

        // Check review period status
        async function checkReviewPeriod() {
            try {
                const isActive = await contract.isReviewPeriodActive();
                const statusText = isActive ? "‚úÖ Review period active" : "‚ùå Review period not started";
                document.getElementById('reviewStatus').textContent = statusText;
            } catch (error) {
                console.error("Failed to check review period:", error);
                document.getElementById('reviewStatus').textContent = "Failed to check status";
            }
        }

        // Check reviewer status
        async function checkReviewerStatus() {
            try {
                const isAuthorized = await contract.authorizedReviewers(userAccount);
                if (isAuthorized) {
                    document.getElementById('reviewerRegistration').style.display = 'none';
                    document.getElementById('reviewSection').style.display = 'block';
                    await loadWorksToReview();
                }
            } catch (error) {
                console.error("Failed to check reviewer status:", error);
            }
        }

        // Load works to review
        async function loadWorksToReview() {
            try {
                const currentPeriod = await contract.currentReviewPeriod();
                const workCount = await contract.workCountPerPeriod(currentPeriod);

                const worksContainer = document.getElementById('worksToReview');
                worksContainer.innerHTML = '';

                for (let i = 1; i <= workCount; i++) {
                    const workInfo = await contract.getSubmissionInfo(currentPeriod, i);

                    const workCard = document.createElement('div');
                    workCard.className = 'submission-card';
                    workCard.innerHTML = `
                        <h4>${workInfo.title}</h4>
                        <p><strong>Author:</strong> ${workInfo.author}</p>
                        <p><strong>Genre:</strong> ${workInfo.genre}</p>
                        <button class="btn" onclick="startReview(${i})">Review This Work</button>
                    `;
                    worksContainer.appendChild(workCard);
                }
            } catch (error) {
                console.error("Failed to load works to review:", error);
            }
        }

        // Start review
        function startReview(workId) {
            document.getElementById('reviewWorkId').value = workId;
            document.getElementById('reviewForm').style.display = 'block';
        }

        // Load submissions
        async function loadSubmissions() {
            try {
                const currentPeriod = await contract.currentSubmissionPeriod();
                const stats = await contract.getPeriodStats(currentPeriod);

                // Update submission count
                document.getElementById('totalSubmissions').textContent = stats.totalSubmissions;

                // Load specific submission information
                const submissionsContainer = document.getElementById('submissionsList');
                submissionsContainer.innerHTML = '';

                for (let i = 1; i <= stats.totalSubmissions; i++) {
                    try {
                        const workInfo = await contract.getSubmissionInfo(currentPeriod, i);

                        const submissionCard = document.createElement('div');
                        submissionCard.className = 'submission-card';
                        submissionCard.innerHTML = `
                            <h4>${workInfo.title}</h4>
                            <div class="submission-info">
                                <p><strong>Author:</strong> ${workInfo.author}</p>
                                <p><strong>Genre:</strong> ${workInfo.genre}</p>
                                <p><strong>Status:</strong> ${workInfo.reviewed ? 'Reviewed' : 'Pending Review'}</p>
                                <p><strong>Submitted:</strong> ${new Date(workInfo.submissionTime * 1000).toLocaleDateString()}</p>
                            </div>
                        `;
                        submissionsContainer.appendChild(submissionCard);
                    } catch (error) {
                        console.error(`Failed to load submission ${i}:`, error);
                    }
                }
            } catch (error) {
                console.error("Failed to load submissions:", error);
            }
        }

        // Submit work form handler
        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('workTitle').value;
            const author = document.getElementById('authorName').value;
            const genre = document.getElementById('workGenre').value;
            const ipfsHash = document.getElementById('workContent').value;

            try {
                showNotification("Submitting work...");
                const tx = await contract.submitWork(title, author, genre, ipfsHash);
                await tx.wait();

                showNotification("Work submitted successfully!");
                document.getElementById('submitForm').reset();
                loadSubmissions();
            } catch (error) {
                console.error("Submission failed:", error);
                showNotification("Submission failed: " + error.message, "error");
            }
        });

        // Reviewer registration
        document.getElementById('reviewerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('reviewerName').value;
            const expertise = document.getElementById('expertise').value;

            try {
                showNotification("Applying for reviewer status...");
                const tx = await contract.registerReviewer(name, expertise);
                await tx.wait();

                showNotification("Application submitted successfully! Awaiting admin approval.");
                document.getElementById('reviewerForm').reset();
            } catch (error) {
                console.error("Application failed:", error);
                showNotification("Application failed: " + error.message, "error");
            }
        });

        // Submit review form handler
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const workId = document.getElementById('reviewWorkId').value;
            const qualityScore = document.getElementById('qualityScore').value;
            const originalityScore = document.getElementById('originalityScore').value;
            const impactScore = document.getElementById('impactScore').value;
            const comments = document.getElementById('comments').value;

            try {
                showNotification("Submitting review...");
                const tx = await contract.submitReview(
                    workId,
                    qualityScore,
                    originalityScore,
                    impactScore,
                    comments
                );
                await tx.wait();

                showNotification("Review submitted successfully!");
                cancelReview();
                loadWorksToReview();
            } catch (error) {
                console.error("Review submission failed:", error);
                showNotification("Review submission failed: " + error.message, "error");
            }
        });

        // Cancel review
        function cancelReview() {
            document.getElementById('reviewForm').style.display = 'none';
            document.getElementById('reviewForm').reset();
        }

        // Load status data
        async function loadStatusData() {
            try {
                const submissionPeriod = await contract.currentSubmissionPeriod();
                const reviewPeriod = await contract.currentReviewPeriod();
                const submissionActive = await contract.isSubmissionPeriodActive();
                const reviewActive = await contract.isReviewPeriodActive();

                document.getElementById('currentSubmissionPeriod').textContent = submissionPeriod;
                document.getElementById('currentReviewPeriod').textContent = reviewPeriod;
                document.getElementById('submissionActive').textContent = submissionActive ? "Active" : "Inactive";
                document.getElementById('reviewActive').textContent = reviewActive ? "Active" : "Inactive";
            } catch (error) {
                console.error("Failed to load status:", error);
            }
        }

        // Load awards data
        async function loadAwardsData() {
            try {
                const currentPeriod = await contract.currentReviewPeriod();
                if (currentPeriod > 0) {
                    const awards = await contract.getAwards(currentPeriod);

                    const awardsList = document.getElementById('awardsList');
                    awardsList.innerHTML = '';

                    if (awards.categories.length === 0) {
                        awardsList.innerHTML = '<p style="text-align:center; color:#666;">No awards announced yet</p>';
                    } else {
                        awards.categories.forEach((category, index) => {
                            if (awards.announced[index]) {
                                const awardItem = document.createElement('div');
                                awardItem.className = 'award-item';
                                awardItem.innerHTML = `
                                    <div>
                                        <strong>${category}</strong>
                                        <br>
                                        <small>Winner: ${awards.winners[index]}</small>
                                    </div>
                                `;
                                awardsList.appendChild(awardItem);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error("Failed to load awards data:", error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Wait for ethers to be fully loaded
            if (typeof ethers !== 'undefined') {
                initWeb3();
            } else {
                console.error('Ethers library not loaded');
                showNotification('Failed to load Web3 library', 'error');
            }
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    initWeb3();
                } else {
                    updateConnectionStatus(false);
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>